@using Sentry.data.Core.GlobalEnums;

@model Sentry.data.Web.SearchIndexModel

@{
    ViewBag.Title = "Datasets";
    @Html.AntiForgeryToken()
}

<div id="search-pg-wrapper" class="container-fluid">
    <div class="row">

        @* filters *@
        <div id="search-pg-filters" class="col-lg-2 col-md-3 hidden-sm hidden-xs">
            <div id="filterColumn" style="display:none;">
                <!-- ko foreach: AllFilters -->
                @* category header *@
                <div class="panel panel-default dataset-list-filters">
                    <div class="panel-heading filterHead" data-bind="attr: { id: HeadId }">
                        <strong data-bind="text : Name"></strong>
                        <span class="glyphicon glyphicon-chevron-down rightFloat filterViewIcon" data-bind="attr: { id: HeadIcon }"></span>
                    </div>

                    @* foreach of the category filters *@
                    <div class="dataset-list-filter-category panel-body" data-bind="attr: {id : HeadHide }" style="display: none;">
                        <!-- ko if: OrderedFilters().length > 0 -->
                        <ul class="list-unstyled ul-filter-list">

                            <!-- ko foreach: OrderedFilters -->
                            <li class="list-unstyled li-filter-disabled filterList" data-bind="visible: $index() < 6">
                                <label data-bind="attr: { id: id }">
                                    <input type="checkbox" class="filterChbx"
                                           data-bind="value: id, checked: window.vm.SelectedFilters, attr: { id: id }" />
                                    <strong data-bind="text : Title"></strong>
                                    <span class="filter-tile-count">(<!--ko text: Count--><!--/ko-->)</span>
                                </label>
                            </li>
                            <!-- /ko -->

                            <li data-bind="attr: {id : HiddenMore}">
                                <!-- ko foreach: OrderedFilters -->
                                <ul class="notNested">
                                    <li class="list-unstyled li-filter-disabled filterList" data-bind="visible: $index() >= 6">
                                        <label data-bind="attr: { id: id }">
                                            <input type="checkbox" class="filterChbx"
                                                   data-bind="value: id, checked: window.vm.SelectedFilters, attr: { id: id }" />
                                            <strong data-bind="text : Title"></strong>
                                            <span class="filter-tile-count">(<!--ko text: Count--><!--/ko-->)</span>
                                        </label>
                                    </li>
                                </ul>
                                <!-- /ko -->
                            </li>

                        </ul>
                        <!-- /ko -->
                        <!-- ko if: OrderedFilters().length > 6 -->
                        <a href="#" class="filterMore" data-bind="attr: { id:  HiddenId}">
                            <div class="glyphicon glyphicon-plus-sign inlineBlock moreIcon leftFloat" data-bind="attr : {id : IconMore}"></div>
                            <div class="leftFloat txt_filterMore" data-bind="attr: {id: TxtMore}">Show More</div>
                        </a>
                        <!-- /ko -->

                    </div>
                </div>

                <!-- /ko -->
            </div>
        </div>

        <div class="col-lg-2 col-md-3 hidden-sm hidden-xs">@* placeholder (keep empty) *@</div>

        <div id="main" class="col-lg-10 col-md-9 col-sm-9 fill">
            <div id="search-pg-content-wrapper">
                @* page title *@
                <div class="listHeadGroup">
                    <div data-bind="visible: IsShownForCurrentType('Datasets')" style="display: none;"><img src="~/Images/Icons/DatasetsBlue.svg" class="datasetImg leftFloat" /></div>
                    <div data-bind="visible: IsShownForCurrentType('BusinessIntelligence')" style="display: none;"><img src="~/Images/Icons/Business IntelligenceBlue.svg" class="datasetImg leftFloat" /></div>
                    <div data-bind="visible: IsShownForCurrentType('Datasets')" style="display: none;"><h1 class="htCenter datasetHeader">Datasets</h1></div>
                    <div data-bind="visible: IsShownForCurrentType('BusinessIntelligence')" style="display: none;"><h1 class="htCenter datasetHeader">Business Intelligence</h1></div>
                </div>

                @* spinner (shown until content loads) *@
                <div id="filterSpinner">
                    <div class="sentry-spinner-container" style="padding-top: 150px; margin-left: -80px;">
                        <span class="sentry-spinner"></span>
                    </div>
                </div>

                @* search box *@
                <div class="searchBoxDS  has-feedback has-feedback-left">
                    <input class="form-control searchTextDS text-box single-line" id="SearchText" placeholder="Search Datasets..." name="SearchText" type="text" data-bind="value: Query, valueUpdate: 'keyup', visible: IsShownForCurrentType('Datasets'), event: {'keyup': searchResults.toFirstPage }" autocomplete="off" style="display: none;">
                    <input class="form-control searchTextDS text-box single-line" id="SearchText" placeholder="Search Exhibits and Dashboards..." name="SearchText" type="text" data-bind="value: Query, valueUpdate: 'keyup', visible: IsShownForCurrentType('BusinessIntelligence')" autocomplete="off" style="display: none;">
                    <i class="form-control-feedback glyphicon glyphicon-search"></i>
                </div>

                @* filters/tiles (hidden by default until content loads *@
                <div id="dataColumn" style="display:none;">
                    <div id="DatasetItemList" class="dataset-list inlineBlock text-left">
                        <div>
                            <h4 class="found">
                                Active Filters:
                                <button type="button" class="btn btn-sm btn-primary" id="btnClearFilters" data-bind="click: clearFilters, enable: SelectedFilters().length !== 0">Clear Filters</button>
                            </h4>

                            <select multiple="" class="form-control select2-hidden-accessible"
                                    id="filterSelector" name="filterSelector" tabindex="-1" aria-hidden="true">
                                <!-- ko foreach: AllFilters -->
                                <optgroup data-bind="attr: {label: Name}">
                                    <!-- ko foreach: Filters -->
                                    <option data-bind="value: $data.id, text: $data.Title"></option>
                                    <!-- /ko -->
                                </optgroup>
                                <!-- /ko -->
                            </select>
                        </div>

                        <div id="search-tile-header">
                            @* number of items option *@
                            <div id="nbr-search-results-wrapper" class="float-l">
                                <div>Showing</div>
                                <div>
                                    <select id="search-results-choices" class="form-control" data-bind="event: { change: window.vm.limitSearchResults() }">
                                        <option value="15" selected>15</option>
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                        <option value="All">All</option>
                                    </select>
                                </div>
                                <div>results</div>
                            </div>

                            @* sorting control *@
                            <div id="sort-option-wrapper" class="float-r">
                                <div>Sort by</div>
                                <div>
                                    <select id="sort-results" class="form-control" data-bind="event: { change: window.vm.sortExhibits() }">
                                        @foreach (SelectListItem sortOption in Model.SortByOptions)
                                        {
                                            <option value="@sortOption.Value">@sortOption.Text</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>

                        <ul class="list-unstyled" id="listOfDatasets" data-bind="foreach: searchResults.pageItems">
                            <li class="ul-dataset-list-item borderSide_gray boxShadowSm" data-bind="css : BorderColor, click: TileClicked, attr: { title: PrimaryTitle }">
                                <div data-bind="if: $index > 20"></div>
                                <div class="category-type-wrap">
                                    <div class="glyphicon glyphicon-star btnFavorite disregardParentClick" id="btnFavorite" data-bind="attr: {data: DatasetId}, visible: IsFavorite" style="display: none"></div>
                                    <div class="glyphicon glyphicon-star-empty btnFavorite disregardParentClick" id="btnFavorite" data-bind="attr: {data: DatasetId}, visible: IsFavorite == false" style="display: none"></div>
                                    <div class="category-type" data-bind="css: BannerColor">
                                        <span data-bind="text: AbbreviatedCategory" />
                                    </div>
                                </div>
                                <div></div>
                                <div class="dataset-list-content">
                                    <!-- ko foreach: DistinctFileExtensions -->
                                    <div class="extension bg_gray" data-bind="css : $data">
                                        <span data-bind="text: $data" />
                                    </div>
                                    <!-- /ko -->
                                    <span class="search-dataset-name" data-bind="text: DatasetName"></span>
                                    <!-- ko if: IsSecured-->
                                    <i class="glyphicon glyphicon-lock text-primary" data-toggle="tooltip" data-placement="bottom" title="Secure"></i>
                                    <!-- /ko -->
                                </div>

                                <div class="dataset-list-content">
                                    <div class="dataset-list-content-label"></div>
                                    <div class="dataset-list-content-value listDesc">
                                        <span data-bind="text: DatasetDesc"></span>


                                        @*TESTING ONLY - REMOVE THIS CHUNCK*@
                                        <br />
                                        <span>Tags: </span>
                                        <!-- ko foreach: Tags -->
                                        <span data-bind="text: Name"></span>
                                        <!-- /ko -->
                                        <br />
                                        <span>Business Unit: </span>
                                        <span data-bind="text: BusinessUnits"></span>
                                        <br />
                                        <span>Functions: </span>
                                        <span data-bind="text: DatasetFunctions"></span>

                                    </div>
                                </div>
                                <div class="dataset-list-content">
                                    <span class="custom-glyphiconz" aria-hidden="true" />
                                    <div class="dataset-list-content-label">
                                        <div>
                                            <div class="ownerDate">
                                                <span class="textBold ownerDate" data-bind="css : Color">Sentry Owner:&nbsp;</span>
                                                <span data-bind="text: SentryOwner"></span>

                                                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;

                                                <!-- ko ifnot: Type === "RPT" -->
                                                <span class=" textBold ownerDate" data-bind="css : Color">Last Activity Date:&nbsp;</span>
                                                <span data-bind="text: ChangedDtm"></span>
                                                <!-- /ko -->
                                                <!-- ko if: Type === "RPT" -->
                                                <span class=" textBold ownerDate" data-bind="css : Color">Refresh Frequency:&nbsp;</span>
                                                <span data-bind="text: UpdateFrequency"></span>

                                                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                                                <span class="textBold ownerDate link-btn btn btn-sm btn-info disregardParentClick" title="Go to the detail page">
                                                    <span class="disregardParentClick">Detail</span>
                                                </span>
                                                <!-- /ko -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>

                        <div id="search-tile-footer" class="text-right">

                            @* search results info display *@
                            <div id="search-results-wrapper" class="footer-container">
                                Results <span data-bind="text: searchResults.firstItemOnPage()"></span>-<span data-bind="text: searchResults.lastItemOnPage()"></span> of <span data-bind="text: searchResults.itemCount()"></span>
                            </div>

                            @* pagination controls *@
                            <div id="pagination-wrapper">
                                <ul class="pagination">
                                    @* button to take you directly to the first page *@
                                    <li data-bind="css: { disabled: searchResults.isFirstPage() }" class="previous disabled">
                                        <a href="#" aria-label="First" data-bind="click: searchResults.toFirstPage" title="First">&laquo;</a>
                                    </li>
                                    @* button to take you to the prevoius page *@
                                    <li data-bind="css: { disabled: !searchResults.hasPreviousPage() }" class="previous disabled">
                                        <a href="#" aria-label="Previous" data-bind="click: searchResults.toPreviousPage" title="Previous">&lt;</a>
                                    </li>

                                    @* loop through the pages, building a button for each *@
                                    <!-- ko foreach: searchResults.pages -->
                                    <li data-bind="css: { active: $data == $parent.searchResults.pageNumber() }">
                                        <a href="#" data-bind="text: $data, click: $parent.searchResults.pageNumber.bind($data)"></a>
                                    </li>
                                    <!-- /ko -->
                                    @* button to take you to the next page*@
                                    <li data-bind="css: { disabled: !searchResults.hasNextPage() }" class="next disabled">
                                        <a href="#" aria-label="Next" data-bind="click: searchResults.toNextPage" title="Next">&gt;</a>
                                    </li>
                                    @* button to take you directly to the last page *@
                                    <li data-bind="css: { disabled: searchResults.isLastPage() }" class="next disabled">
                                        <a href="#" aria-label="Last" data-bind="click: searchResults.toLastPage" title="Last">&raquo;</a>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <hr>
                        <!-- ko if: searchResults().length == 0 -->
                        <div>
                            <h4>
                                No results given the active filters and/or search text.  Please refine your search parameters.
                            </h4>
                        </div>
                        <!-- /ko -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            var $selector = $("#filterSelector").select2({
                selectOnClose: false,
                closeOnSelect: false,
                templateSelection: formatTag,
                placeholder: "There are no active filters.  Pick an option to the left or click here to begin filtering.",
            });
            $selector.select2({
                selectOnClose: false,
                closeOnSelect: false,
                templateSelection: formatTag,
                placeholder: "There are no active filters.  Pick an option to the left or click here to begin filtering.",
            });

            // remove the "container" class from the parent object so the fluid container takes affect
            $("#search-pg-wrapper").parent().removeClass("container");

            //This is fed into the Select2 Box to format tags.
            function formatTag(tag) {
                var cat = "";

                for (var i = 0; i < vm.AllFilters().length; i++) {
                    for (var j = 0; j < vm.AllFilters()[i].Filters().length; j++) {
                        if (vm.AllFilters()[i].Filters()[j].id === tag.id) {
                            cat = vm.AllFilters()[i].Filters()[j].Category;
                            break;
                        }
                    }
                    if (cat !== "") {
                        break;
                    }
                }

                var $state = $(
                    '<span class="' + cat.split(" ").join("_").toLowerCase() + '_filter">' + cat + " : " + tag.text + '</span>'
                );

                return $state;
            };


            $('body').on('mouseenter', ".ul-dataset-list-item", function (e) {
                $(this).css('background-color', $(this).css("border-color").slice(0, -1) + ', 0.1)')
            });

            $('body').on('mouseleave', ".ul-dataset-list-item", function (e) {
                $(this).css('background-color', 'white')
            });

            $('.select2-container--default').css('width', '100%');

            $('#filterSelector').on('select2:select', function (e) {
                
                var data = e.params.data;

                // push the selected filter Id to the observable array
                window.vm.SelectedFilters.push(data.id);
            });

            $('#filterSelector').on('select2:unselect', function (e) {
                
                var data = e.params.data;

                // remove the selected filter Id from the observable array
                window.vm.RemoveSelection(data.id);
            });
        });

        function getDetailType() {
            return window.location.pathname.split("/")[2];
        }

        function Filter(id, Title, Category, Count) {

            this.id = id;
            this.Title = Title;
            this.Category = Category;

            this.Count = ko.computed(function () {

                var selectedFilters = [];//push them into a new array so we do not modify the original.
                ko.utils.arrayForEach(window.vm.SelectedFilters(), function (filter) { selectedFilters.push(filter);  });

                //OR Group
                var selectedCategories = GetSelectedFiltersFromGroup(window.vm.CategoryFilters, selectedFilters);
                var selectedBusinessUnits = GetSelectedFiltersFromGroup(window.vm.BusinessUnitFilters, selectedFilters);
                var selectedFunctions = GetSelectedFiltersFromGroup(window.vm.DatasetFunctionFilters, selectedFilters);
                var selectedExtensions = GetSelectedFiltersFromGroup(window.vm.ExtensionFilters, selectedFilters);
                var selectedOwners = GetSelectedFiltersFromGroup(window.vm.OwnerFilters, selectedFilters);

                var items = [];

                if (Category === 'Category') {
                    //filter datasets for the count
                    var datasetsToLoop = filterForCount(selectedFilters, selectedCategories);
                    items = ko.utils.arrayFilter(datasetsToLoop, function (dataset) {
                        if (dataset.Categories.includes(Title)) { return dataset; }
                    });
                }
                else if (Category === 'Sentry Owner') {
                    //filter datasets for the count
                    var datasetsToLoop = filterForCount(selectedFilters, selectedOwners);
                    items = ko.utils.arrayFilter(datasetsToLoop, function (dataset) {
                        if (dataset.SentryOwner === Title) { return dataset; }
                    });
                }
                else if (Category === 'Extension' || Category === "Report Type") {
                    //filter datasets for the count
                    var datasetsToLoop = filterForCount(selectedFilters, selectedExtensions);
                    items = ko.utils.arrayFilter(datasetsToLoop, function (dataset) {
                        if (dataset.DistinctFileExtensions.includes(Title)) { return dataset; }
                    });
                }
                else if (Category === 'Business Unit') {
                    //filter datasets for the count
                    var datasetsToLoop = filterForCount(selectedFilters, selectedBusinessUnits);
                    items = ko.utils.arrayFilter(datasetsToLoop, function (dataset) {
                        if (dataset.BusinessUnits.includes(Title)) { return dataset; }
                    });
                }
                else if (Category === 'Function') {
                    //filter datasets for the count
                    var datasetsToLoop = filterForCount(selectedFilters, selectedFunctions);
                    items = ko.utils.arrayFilter(datasetsToLoop, function (dataset) {
                        if (dataset.DatasetFunctions.includes(Title)) { return dataset; }
                    });
                }
                else {
                    //This is going to be all teh Tags within different groups.  All of them are AND'd together and should filter off the searchResults.
                    //filter datasets for the count
                    var datasetsToLoop = window.vm.searchResults();
                    // all AND groups here
                    items = ko.utils.arrayFilter(datasetsToLoop, function (dataset) {
                        if (dataset.TagNames.includes(Title)) { return dataset; }
                    });
                }

                return items.length;
            });
        }

        function filterForCount(selectedFilters, filtersToRemove) {
            //build my selected fitler (all filters but Business Unit)
            ko.utils.arrayForEach(filtersToRemove, function (item) {
                selectedFilters.splice(selectedFilters.indexOf(item.id), 1);
            });

            return FilterExhibits(window.vm.datasets(), "0", selectedFilters);
        }

        function FilterCategory(Name, Filters) {
            var self = this;

            self.Name = Name;

            self.Filters = ko.observableArray(Filters);

            self.HiddenId = 'filterMore_' + Name.replace(' ', '_');
            self.HiddenMore = 'hidden_filterMore_' + Name.replace(' ', '_');
            self.IconMore = 'icon_filterMore_' + Name.replace(' ', '_');
            self.TxtMore = 'txt_filterMore_' + Name.replace(' ', '_');

            self.HeadId = 'filterType_' + Name.replace(' ', '_');
            self.HeadIcon = 'icon_filterType_' + Name.replace(' ', '_');
            self.HeadHide = 'hide_filterType_' + Name.replace(' ', '_');

            self.OrderedFilters = ko.computed(function () {

                var list = ko.utils.arrayFilter(self.Filters(), function (prod) {
                    return prod;
                });

                //Sort the list alphabetically and show them to the user.
                return list.sort(function (left, right) {
                    return left.Title == right.Title ? 0 : (left.Title < right.Title ? -1 : 1)
                });
            });

        }

        function Dataset(data) {
            var self = this;

            self.DatasetDesc = data.DatasetDesc;
            self.SentryOwner = data.SentryOwnerName;
            self.DatasetId = data.DatasetId;

            self.DatasetInformation = data.DatasetInformation;
            self.DatasetName = data.DatasetName;
            self.Category = data.Category;
            self.AbbreviatedCategory = data.AbbreviatedCategory;
            self.IsSecured = data.IsSecured;
            self.Type = data.Type;

            self.PrimaryTitle = ko.computed(function () {
                if (self.Type === "RPT") {
                    return "Click here to open.";
                } else {
                    return "Click here to go to the Dataset Detail Page.";
                }
            });

            self.TileClicked = function (item, e) {

                if ($(e.target).hasClass("btnFavorite") === true) {
                    return false;
                }
                else if (self.Type === "RPT") {
                    //What is the primary function of clicking on the tile if its a Report
                    //And you did not click on a button.
                    if ($(e.target).hasClass("disregardParentClick") === false) {
                        if (self.LocationType === "file") {
                            vm.GetFile(self);
                        }
                        else {
                            var win = window.open(data.Location, '_blank');
                            if (win) {
                                //Browser has allowed it to be opened
                                win.focus();
                            } else {
                                //Browser has blocked it
                                alert('Please allow popups for this website');
                            }
                        }
                    }
                    //And you did click on the button
                    else {

                        window.location.href = "/BusinessIntelligence/Detail/" + data.DatasetId;
                    }


                } else {
                     //What is the primary function of clicking on the tile if its a Dataset.
                    window.location.href = "/Dataset/Detail/" + data.DatasetId;
                }

                return false;
            };

            self.CreatedDtm = data.CreatedDtm;
            self.ChangedDtm = data.ChangedDtm;
            self.Color = data.Color;

            self.BannerColor = data.BannerColor;
            self.BorderColor = data.BorderColor;

            self.Categories = data.Categories;
            self.DistinctFileExtensions = data.DistinctFileExtensions;
            self.BusinessUnits = data.BusinessUnits;
            self.DatasetFunctions = data.DatasetFunctions;

            self.PageViews = data.PageViews;
            self.Downloads = data.Downloads;

            self.Location = data.Location;
            self.LocationType = data.LocationType;
            self.Tags = data.Tags;
            self.UpdateFrequency = data.UpdateFrequency;
            self.CanEditDataset = data.CanEditDataset;
            self.IsFavorite = data.IsFavorite;

            self.TagNames = [];
            if (data.Tags !== null && data.Tags.length !== 0) {
                ko.utils.arrayForEach(data.Tags, function (v) {
                    self.TagNames.push(v.Name);
                });
            }

            self.CanSeeDetails = ko.computed(function () {
                if ((self.Type === "RPT" && self.CanEditDataset) || self.Type !== "RPT") {
                    return true;
                }
                else {
                    return false;
                }
            });

        }

        function GetSelectedFiltersFromGroup(allFiltersFromGroup, mySelectedFilters) {

            if (allFiltersFromGroup().length === 0) {
                return allFiltersFromGroup();
            }

            var filters = ko.utils.arrayFilter(allFiltersFromGroup(), function (feature)
            {
                for (var i = 0; i < mySelectedFilters.length; i++) {
                    if (feature.id == mySelectedFilters[i]) {
                        return true;
                    }
                }
                return false;
            });

            return filters;
        }

        //This only should be used for the Category type filter groups the ones that are 'OR'ed together when multiple selected in the same box.
        function IsSelectedFiltersAMatch(selectedFilters, datasetObjectArray, isAndOperator) {

            if (selectedFilters.length === 0) {
                return true;
            } else if (datasetObjectArray.length === 0) {
                return false;
            } else {
                for (var i = 0; i < selectedFilters.length; i++) {
                    if (isAndOperator && datasetObjectArray.includes(selectedFilters[i].Title)) {
                        return true;
                    }
                    else if (!isAndOperator && !datasetObjectArray.includes(selectedFilters[i].Title)) {
                        return false;
                    }
                }
            }

            return !isAndOperator;
        }

        function FilterExhibits(exhibits, sortVal, selectedFilters) {

            if (selectedFilters.length === 0 || window.vm === undefined) {
                return sortTheResults(sortVal, exhibits);
            }

            //get all the filerters selected from the category group
            var selectedCategories = GetSelectedFiltersFromGroup(window.vm.CategoryFilters, selectedFilters);
            var selectedBusinessUnits = GetSelectedFiltersFromGroup(window.vm.BusinessUnitFilters, selectedFilters);
            var selectedFunctions = GetSelectedFiltersFromGroup(window.vm.DatasetFunctionFilters, selectedFilters);
            var selectedExtensions = GetSelectedFiltersFromGroup(window.vm.ExtensionFilters, selectedFilters);
            var selectedTags = GetSelectedFiltersFromGroup(window.vm.TagFilters, selectedFilters);
            var selectedOwners = GetSelectedFiltersFromGroup(window.vm.OwnerFilters, selectedFilters);

            //filter the exhibits based on teh groups that are 'OR'ed toghether
            exhibits = exhibits.filter(function (exhibit) {
                var categoryMatch = IsSelectedFiltersAMatch(selectedCategories, exhibit.Categories, true);
                var buMatch = IsSelectedFiltersAMatch(selectedBusinessUnits, exhibit.BusinessUnits, true);
                var extensionMatch = IsSelectedFiltersAMatch(selectedExtensions, exhibit.DistinctFileExtensions, true);
                var functionMatch = IsSelectedFiltersAMatch(selectedFunctions, exhibit.DatasetFunctions, true);
                var ownerMatch = IsSelectedFiltersAMatch(selectedOwners, exhibit.SentryOwner.split(", "), true);

                //now filter the rest of the exhibits on the groups that are 'AND'ed together.
                var tagMatch = IsSelectedFiltersAMatch(selectedTags, exhibit.TagNames, false);

                return categoryMatch && buMatch && functionMatch && extensionMatch && ownerMatch && tagMatch;
            });

            return sortTheResults(sortVal, exhibits);
        }

        function ListViewModel() {
            var self = this;
            self.Query = ko.observable('');
            self.datasets = ko.observableArray([]);
            self.AllFilters = ko.observableArray([]);  //This is the master list of all filters.
            self.SelectedFilters = ko.observableArray([]);
            self.CategoryFilters = ko.observableArray([]);
            self.BusinessUnitFilters = ko.observableArray([]);
            self.DatasetFunctionFilters = ko.observableArray([]);
            self.OwnerFilters = ko.observableArray([]);
            self.ExtensionFilters = ko.observableArray([]);
            self.TagFilters = ko.observableArray([]);

            self.FilterExhibits = function (exhibits, sortVal) {
                return FilterExhibits(exhibits, sortVal, self.SelectedFilters());
            };

            self.PopulateDatasetFilters = function (datasets) {
                var temp = [];
                var pageType = '1_';

                //CATEGORY FILTER
                for (var item, i = 0; item = datasets[i++];) {
                    var category = item.Category;

                    if (!(category in categoryLookup)) {
                        categoryLookup[category] = 1;
                        self.CategoryFilters.push(new Filter(pageType + '0_' + i, category, 'Category'));

                        temp.push(new Filter(pageType + '0_' + i, category, 'Category'));

                        // compare the category to what may have been passed along in the URL; if there's a match, push it to the SelectedFilters observable array
                        if (category === getParameterByName('category')) {
                            self.SelectedFilters.push(pageType + '0_' + i);
                        }
                    }
                }

                var item;

                ko.utils.arrayForEach(self.AllFilters(), function (v) {
                    if (v.Name == 'Category') {
                        item = v;
                    }
                });
                if (item !== undefined) {
                    temp = item.Filters().concat(temp);
                    ko.utils.arrayRemoveItem(self.AllFilters(), item);
                }

                self.AllFilters.push(new FilterCategory('Category', temp));
                temp = [];


                //SENTRYOWNER FILTER
                for (var item, i = 0; item = datasets[i++];) {
                    var owner = item.SentryOwner;

                    if (!(owner in ownerLookup)) {
                        ownerLookup[owner] = 1;
                        self.OwnerFilters.push(new Filter(pageType + '1_' + i, owner, 'Sentry Owner'));
                        //self.SearchFilters.push(new Filter('1_' + i, owner, 10));

                        temp.push(new Filter(pageType + '1_' + i, owner, 'Sentry Owner'));
                    }

                }
                ko.utils.arrayForEach(self.AllFilters(), function (v) {
                    if (v.Name == 'Sentry Owner') {
                        item = v;
                    }
                });
                if (item !== undefined) {
                    temp = item.Filters().concat(temp);
                    ko.utils.arrayRemoveItem(self.AllFilters(), item);
                }
                self.AllFilters.push(new FilterCategory('Sentry Owner', temp));
                temp = [];


                //EXTENSION FILTER
                counter = 0; //Needs seperate counter as multiple objects can appear per iteration
                for (var item, i = 0; item = datasets[i++];) {
                    for (var ext, j = 0; ext = item.DistinctFileExtensions[j++];) {
                        if (!(ext in extensionLookup)) {
                            extensionLookup[ext] = 1;
                            self.ExtensionFilters.push(new Filter(pageType + '3_' + counter, ext, 'Extension'));

                            temp.push(new Filter(pageType + '3_' + counter, ext, 'Extension'));
                            counter++;
                        }
                    }
                }
                ko.utils.arrayForEach(self.AllFilters(), function (v) {
                    if (v.Name == 'Extension') {
                        item = v;
                    }
                });
                if (item !== undefined) {
                    temp = item.Filters().concat(temp);
                    ko.utils.arrayRemoveItem(self.AllFilters(), item);
                }
                self.AllFilters.push(new FilterCategory('Extension', temp));
            };

            self.PopulateExhibitFilters = function (exhibits) {
                var temp = [];
                var pageType = '2_'
                var item;

                //CATEGORY FILTER
                for (var item, i = 0; item = exhibits[i++];) {
                    for (var cat, j = 0; cat = item.Categories[j++];) {
                        if (!(cat in categoryLookup)) {
                            categoryLookup[cat] = 1;
                            self.CategoryFilters.push(new Filter(pageType + '0_' + i, cat, 'Category'));

                            // compare the category to what may have been passed in the URL; if there's a match, push it to the SelectedFilters observable array
                            if (cat === getParameterByName('category')) {
                                self.SelectedFilters.push(pageType + '0_' + i);
                            }

                            temp.push(new Filter(pageType + '0_' + i, cat, 'Category'));
                        }
                    }
                }
                ko.utils.arrayForEach(self.AllFilters(), function (v) {
                    if (v.Name == 'Category') {
                        item = v;
                    }
                });
                if (item !== undefined) {
                    temp = item.Filters().concat(temp);
                    ko.utils.arrayRemoveItem(self.AllFilters(), item);
                }
                self.AllFilters.push(new FilterCategory('Category', temp));
                temp = [];


                //BUSINESS UNIT FILTER
                counter = 0; //reset counter
                for (var item, i = 0; item = exhibits[i++];) {
                    for (var bu, j = 0; bu = item.BusinessUnits[j++];) {
                        if (!(bu in businessUnitLookup)) {
                            businessUnitLookup[bu] = 1;
                            self.BusinessUnitFilters.push(new Filter(pageType + '5_' + counter, bu, 'Business Unit'));

                            temp.push(new Filter(pageType + '5_' + counter, bu, 'Business Unit'));
                            counter++;
                        }
                    }
                }
                ko.utils.arrayForEach(self.AllFilters(), function (v) {
                    if (v.Name == 'Business Unit') {
                        item = v;
                    }
                });
                if (item !== undefined) {
                    temp = item.Filters().concat(temp);
                    ko.utils.arrayRemoveItem(self.AllFilters(), item);
                }
                self.AllFilters.push(new FilterCategory('Business Unit', temp));
                temp = [];


                //DATASET FUNCTION FILTER
                counter = 0; //reset counter
                for (var item, i = 0; item = exhibits[i++];) {
                    for (var fn, j = 0; fn = item.DatasetFunctions[j++];) {
                        if (!(fn in datasetFunctionLookup)) {
                            datasetFunctionLookup[fn] = 1;
                            self.DatasetFunctionFilters.push(new Filter(pageType + '6_' + counter, fn, 'Function'));

                            temp.push(new Filter(pageType + '6_' + counter, fn, 'Function'));
                            counter++;
                        }
                    }
                }
                ko.utils.arrayForEach(self.AllFilters(), function (v) {
                    if (v.Name == 'Function') {
                        item = v;
                    }
                });
                if (item !== undefined) {
                    temp = item.Filters().concat(temp);
                    ko.utils.arrayRemoveItem(self.AllFilters(), item);
                }
                self.AllFilters.push(new FilterCategory('Function', temp));
                temp = [];


                //REPORT TYPE FILTER
                counter = 0; // reset the counter
                for (var item, i = 0; item = exhibits[i++];) {
                    for (var ext, j = 0; ext = item.DistinctFileExtensions[j++];) {
                        if (!(ext in extensionLookup)) {
                            extensionLookup[ext] = 1;
                            self.ExtensionFilters.push(new Filter(pageType + '2_' + counter, ext, 'Report Type'));

                            temp.push(new Filter(pageType + '2_' + counter, ext, 'Report Type'));
                            counter++;
                        }
                    }
                }
                ko.utils.arrayForEach(self.AllFilters(), function (v) {
                    if (v.Name == 'Report Type') {
                        item = v;
                    }
                });
                if (item !== undefined) {
                    temp = item.Filters().concat(temp);
                    ko.utils.arrayRemoveItem(self.AllFilters(), item);
                }
                self.AllFilters.push(new FilterCategory('Report Type', temp));
                temp = [];


                //TAG FILTER
                //Retrieve unique list of tag groups across tags that exist on exhibits
                // and alfa sort the list
                var tagGroups = $.unique($.map(exhibits, function (nested) {
                        return $.map(nested.Tags, function (element) {
                            return element.Group;
                        });
                    })
                ).sort();

                //Move "Other" group to end of array if exists for display purposes
                function array_move(arr, old_index, new_index) {
                    if (new_index >= arr.length) {
                        var k = new_index - arr.length + 1;
                        while (k--) {
                            arr.push(undefined);
                        }
                    }
                    arr.splice(new_index, 0, arr.splice(old_index, 1)[0]);
                };

                array_move(tagGroups, tagGroups.indexOf('Other'), tagGroups.length - 1)


                counter = 0; //Needs seperate counter as multiple objects can appear per iteration
                //Loop through each tag group, add all tags for the group which are associated
                // with each exhibit
                for (var group, g = 0; group = tagGroups[g++];) {
                    for (var item, i = 0; item = exhibits[i++];) {
                        if (item.Tags != null) {
                            var Tags = item.Tags;
                            //Loop through list of Tags on each item
                            for (var tag, j = 0; tag = Tags[j++];) {
                                if (tag.Group == group && !(tag.Name in tagLookup)) {
                                    tagLookup[tag.Name] = 1;
                                    self.TagFilters.push(new Filter(pageType + '3_' + counter, tag.Name, group));

                                    temp.push(new Filter(pageType + '3_' + counter, tag.Name, group));
                                    counter++;
                                }
                            }
                        }
                    }
                    ko.utils.arrayForEach(self.AllFilters(), function (v) {
                        if (v.Name == group) {
                            item = v;
                        }
                    });
                    if (item !== undefined) {
                        temp = item.Filters().concat(temp);
                        ko.utils.arrayRemoveItem(self.AllFilters(), item);
                    }
                    self.AllFilters.push(new FilterCategory(group, temp));

                    temp = [];
                }

            };

            self.PopulateGenericFilters = function (allObjects) {
                var temp = [];
                var pageType = '3_'

                //CATEGORY FILTER
                var param = getParameterByName('category');

                for (var item, i = 0; item = allObjects[i++];) {
                    var category = item.Category;

                    if (!(category in categoryLookup)) {
                        categoryLookup[category] = 1;
                        self.CategoryFilters.push(new Filter(pageType + '0_' + i, category, 'Category'));

                        temp.push(new Filter(pageType + '0_' + i, category, 'Category'));

                        if (category == param) {
                            self.SelectedFilters.push(pageType + '0_' + i);
                        }
                    }
                }

                var item;

                ko.utils.arrayForEach(self.AllFilters(), function (v) {
                    if (v.Name == 'Category') {
                        item = v;
                    }
                });
                if (item !== undefined) {
                    temp = item.Filters().concat(temp);
                    ko.utils.arrayRemoveItem(self.AllFilters(), item);
                }

                self.AllFilters.push(new FilterCategory('Category', temp));
                temp = [];


                //BUSINESS UNIT FILTER
                for (var item, i = 0; item = allObjects[i++];) {
                    for (var bu, j = 0; bu = item.BusinessUnits[j++];) {
                        if (!(bu in businessUnitLookup)) {
                            businessUnitLookup[bu] = 1;
                            self.BusinessUnitFilters.push(new Filter(pagetype + '5_' + counter, bu, 'Business Unit'));

                            temp.push(new Filter(pageType + '5_' + counter, bu, 'Business Unit'));
                            counter++;
                        }
                    }
                }
                ko.utils.arrayForEach(self.AllFilters(), function (v) {
                    if (v.Name === 'Business Unit') {
                        item = v;
                    }
                });
                if (item !== undefined) {
                    temp = item.Filters().concat(temp);
                    ko.utils.arrayRemoveItem(self.AllFilters(), item);
                }
                self.AllFilters.push(new FilterCategory('Business Unit', temp));


                //SENTRYOWNER FILTER
                for (var item, i = 0; item = allObjects[i++];) {
                    var owner = item.SentryOwner;

                    if (!(owner in ownerLookup)) {
                        ownerLookup[owner] = 1;
                        self.OwnerFilters.push(new Filter(pageType + '1_' + i, owner, 'Sentry Owner'));
                        //self.SearchFilters.push(new Filter('1_' + i, owner, 10));

                        temp.push(new Filter(pageType + '1_' + i, owner, 'Sentry Owner'));
                    }

                }
                ko.utils.arrayForEach(self.AllFilters(), function (v) {
                    if (v.Name == 'Sentry Owner') {
                        item = v;
                    }
                });
                if (item !== undefined) {
                    temp = item.Filters().concat(temp);
                    ko.utils.arrayRemoveItem(self.AllFilters(), item);
                }
                self.AllFilters.push(new FilterCategory('Sentry Owner', temp));
                temp = [];


                //EXTENSION FILTER
                counter = 0; //Needs seperate counter as multiple objects can appear per iteration
                for (var item, i = 0; item = allObjects[i++];) {
                    for (var ext, j = 0; ext = item.DistinctFileExtensions[j++];) {
                        if (!(ext in extensionLookup)) {
                            extensionLookup[ext] = 1;
                            self.ExtensionFilters.push(new Filter(pageType + '3_' + counter, ext, 'Extension'));
                            //self.SearchFilters.push(new Filter('1_' + i, owner, 10));

                            temp.push(new Filter(pageType + '3_' + counter, ext, 'Extension'));
                            counter++;
                        }
                    }
                }
                ko.utils.arrayForEach(self.AllFilters(), function (v) {
                    if (v.Name == 'Extension') {
                        item = v;
                    }
                });
                if (item !== undefined) {
                    temp = item.Filters().concat(temp);
                    ko.utils.arrayRemoveItem(self.AllFilters(), item);
                }
                self.AllFilters.push(new FilterCategory('Extension', temp));

                //TAG FILTER
                counter = 0; //Needs seperate counter as multiple objects can appear per iteration
                for (var item, i = 0; item = allObjects[i++];) {
                    if (item.Tags != null) {
                        var Tags = item.Tags;
                        //Loop through list of Tags on each item
                        for (var tag, j = 0; tag = Tags[j++];) {
                            if (!(tag.Name in tagLookup)) {
                                tagLookup[tag.Name] = 1;
                                self.TagFilters.push(new Filter(pageType + '4_' + counter, tag.Name, 'Tag'));

                                temp.push(new Filter(pageType + '4_' + counter, tag.Name, 'Tag'));
                                counter++;
                            }
                        }
                    }
                }
                ko.utils.arrayForEach(self.AllFilters(), function (v) {
                    if (v.Name == 'Tag') {
                        item = v;
                    }
                });
                if (item !== undefined) {
                    temp = item.Filters().concat(temp);
                    ko.utils.arrayRemoveItem(self.AllFilters(), item);
                }
                self.AllFilters.push(new FilterCategory('Tag', temp));
                temp = [];
            };

            self.RemoveSelection = function (id) {
                self.SelectedFilters.remove(function (feature) {
                    return feature == id;
                });
            }

            self.clearFilters = function () {
                self.SelectedFilters.removeAll();
            };

            self.SearchType = ko.computed(function () {
                return getSearchType();
            });

            self.IsShownForCurrentType = function (what) {
                return what === getDetailType();
            };

            var loaded = false;

            var categoryLookup = {};
            var businessUnitLookup = {};
            var datasetFunctionLookup = {};
            var ownerLookup = {};
            var extensionLookup = {};
            var tagLookup = {};

            self.populateFilters = function () {

                var allData = self.datasets();

                if (self.SearchType() == "Datasets") {
                    self.PopulateDatasetFilters(allData);
                } else if (self.SearchType() == "BusinessIntelligence") {
                    self.PopulateExhibitFilters(allData);
                } else {
                    self.PopulateGenericFilters(allData);
                }

            };

            // Load initial state from server, convert it to Dataset instances, then populate self.datasets
            $.getJSON( "/Search/" + self.SearchType() + "/List", function (allData) {
                var mappedTasks = $.map(allData, function (item) { return new Dataset(item) });

                self.datasets(self.datasets().concat(mappedTasks));

                self.populateFilters();

                $('#dataColumn').show();
                $('#filterColumn').show();
                $('.sentry-spinner-container').remove();
                $('.select2-search__field').css({ width: '500px' });
                $('#filterSelector').val(self.SelectedFilters()).trigger('change');
            });

            self.searchResults = ko.computed(function () {

                if (!loaded) {
                    var list = JSON.parse(localStorage.getItem("filteredIds"));

                    if (list != undefined) {

                        for (var i = 0; i < list.length; i++) {
                            self.SelectedFilters.push(list[i]);
                        }
                    }

                    if (getParameterByName('searchPhrase')) {
                        self.Query(getParameterByName('searchPhrase'));
                    }
                    else if (getParameterByName('category')) {
                        self.Query('');
                    }
                    else {
                        var searchText = localStorage.getItem("searchText");

                        if (searchText != undefined && searchText != "") {
                            self.Query(searchText);
                        }
                    }
                    loaded = true;
                }
                else {
                    localStorage.setItem("searchText", self.Query());
                }

                var searchQuery = self.Query().split(" ");

                var temp = [];

                for (var i = 0; i < self.datasets().length; i++) {

                    var keywordFound = false;
                    var count = 0;
                    var dataset = self.datasets()[i];

                    for (var j = 0; j < searchQuery.length; j++) {
                        var desc = dataset.DatasetDesc.toString();
                        var name = dataset.DatasetName.toString();
                        var owner = dataset.SentryOwner.toString();

                        if (desc.toLowerCase().indexOf(searchQuery[j].toLowerCase()) >= 0) {
                            keywordFound = true;
                            count++;
                        }
                        if (owner.toLowerCase().indexOf(searchQuery[j].toLowerCase()) >= 0) {
                            keywordFound = true;
                            count++;
                        }
                        if (name.toLowerCase().indexOf(searchQuery[j].toLowerCase()) >= 0) {
                            keywordFound = true;
                            count++;
                        }
                    }
                    if (keywordFound) {
                        temp.push({ dataset: dataset, count: count });
                    }
                }

                temp = temp.sort(function (left, right) {
                    return right.count - left.count || new Date(right.dataset.ChangedDtm) - new Date(left.dataset.ChangedDtm);
                });

                queryResults = temp.map(x => x.dataset);

                queryResults = self.FilterExhibits(queryResults, $("#sort-results").val());

                $("#SearchText").attr("placeholder", "Search " + queryResults.length + " Datasets...");

                return queryResults;
            }).extend({ paged: { pageSize: 15 } }); // .extend() is for the knockout-paging plugin
            // go to https://github.com/ErikSchierboom/knockout-paging for information on the plugin

            self.sortExhibits = function () {
                self.datasets.valueHasMutated();
            };

            self.limitSearchResults = function () {

                var nbrResults = 15;

                // determine number of results to return in the search results using the value selected in the drop-down
                if ($("#search-results-choices").val() === "All") {
                    nbrResults = self.searchResults.itemCount();
                } else {
                    nbrResults = parseInt($("#search-results-choices").val());
                }

                self.searchResults.pageSize(nbrResults);

            }

            self.SelectedFilters.subscribe(function () {
                localStorage.setItem("filteredIds", ko.toJSON(self.SelectedFilters()));
                $('#filterSelector').val(self.SelectedFilters()).trigger('change');

            });

            self.GetFile = function (data) {
                $.ajax({
                    url: '/ExternalFile/HasReadPermissions?pathAndFilename=' + encodeURIComponent(data.Location),
                    method: "GET",
                    dataType: 'json',
                    success: function (obj) {
                        if (obj.HasPermission) {
                            var url = '/ExternalFile/DownloadExternalFile?pathAndFilename=' + encodeURIComponent(data.Location);
                            window.open(url);
                        }
                        else {
                            Sentry.ShowModalAlert(
                                "User does not have sufficient permissions to selected file. </br></br>  Contact <b>" + data.SentryOwner + "</b> to request access to exhibit."
                            );
                        }
                    },
                    error: function (obj) {
                        Sentry.ShowModalAlert("Failed permissions check, please try again.  If problem persists, please contact <a mailto:DSCSupport@sentry.com></a>");
                    }
                });
            };
        }

        $(document).ready(function () {

            window.vm = new ListViewModel();
            ko.applyBindings(vm);

            if (window.location.href.match(/&ids=/)) {

            }
            else {
                window.vm.clearFilters();
            }

            $(document).on("click", "[id^='filterType_']", function (e) {
                e.preventDefault();

                var id = $(this).attr("id");
                var category = "#hide_" + id
                var icon = "#icon_" + id;

                $(category).slideToggle();
                $(icon).toggleClass("glyphicon-chevron-down glyphicon-chevron-up");
            });

            $(document).on("click", "[id^='filterMore_']", function (e) {
                e.preventDefault();

                var id = $(this).attr("id");
                var show = "#hidden_" + id
                var icon = "#icon_" + id;
                var txt = "#txt_" + id;

                $(show).slideToggle();
                $(icon).toggleClass("glyphicon-plus-sign glyphicon-minus-sign");

                if ($(txt).text() == "Show Less") {
                    $(txt).text("Show More");
                }
                else {
                    $(txt).text("Show Less");
                }
            });

            $(document).on("click", "[id^='btnFavorite']", function (e) {
                e.preventDefault();

                var button = $(this);
                var id = button.attr("data");

                if (button.hasClass("glyphicon-star")) {

                    $.ajax({
                        url: '/Dataset/SetFavorite?datasetId=' + encodeURIComponent(id),
                        method: "GET",
                        dataType: 'json',
                        success: function () {
                        },
                        error: function () {
                            Sentry.ShowModalAlert("Failed to remove favorite.");
                        }
                    });
                }
                else if (button.hasClass("glyphicon-star-empty")) {

                    $.ajax({
                        url: '/Dataset/SetFavorite?datasetId=' + encodeURIComponent(id),
                        method: "GET",
                        dataType: 'json',
                        success: function () {
                        },
                        error: function () {
                            Sentry.ShowModalAlert("Failed to set favorite.");
                        }
                    });
                }

                $(this).toggleClass("glyphicon-star glyphicon-star-empty");

            });
        });

        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        function getSearchType() {
            var regex = /\/Search\/(\w+)/,
                url = window.location.href;
            return regex.exec(url)[1];
        }

        function sortTheResults(sortVal, items) {
            switch (parseInt(sortVal)) {
                case @((int)DatasetSortByOption.Alphabetical):
                    return items.sort(function (left, right) {
                        return left.DatasetName == right.DatasetName ? 0 : (left.DatasetName < right.DatasetName ? -1 : 1)
                    });
                    break;
                case @((int)DatasetSortByOption.Favorites):
                    return items.sort(function (left, right) {
                        return right.IsFavorite - left.IsFavorite;
                    });
                    break;
                case @((int)DatasetSortByOption.MostAccessed):
                    return items.sort(function (left, right) {
                        return right.PageViews - left.PageViews;
                    });
                    break;
                case @((int)DatasetSortByOption.RecentlyAdded):
                    return items.sort(function (left, right) {
                        return new Date(right.CreatedDtm) - new Date(left.CreatedDtm);
                    });
                    break;
                case @((int)DatasetSortByOption.RecentlyUpdated):
                    return items.sort(function (left, right) {
                        return new Date(right.ChangedDtm) - new Date(left.ChangedDtm);
                    });
                    break;
                default:
                    return items;
            }
        }

    </script>
}