@model Sentry.data.Web.ObsoleteDatasetModel

@{
    ViewBag.Title = "Fields";
    Sentry.data.Core.FileSchema schema = ViewBag.Schema;
    string color = Model.DatasetCategory.Color;
    string dateDefault = ViewBag.Date_Default;
    string timestampDefault = ViewBag.Timestamp_Default;
}
<a class="backToList" href="/Config/Dataset/@Model.DatasetId"><span class="glyphicon glyphicon-chevron-left"></span>  Back to Dataset Configuration</a>

<div class="topBanner" style="height: 60px;
    margin-top: 20px;
    border-bottom: 1px #DDDDDD solid;">
    <div class="relative hidden-sm hidden-xs">
        <div>

            <div class="no-overflow">
                <h1 class="detailName leftFloat @color">
                    @Model.DatasetName

                    @if (Model.IsSecured)
                    {
                        <span class="glyphicon glyphicon-lock lockIcon" data-toggle="tooltip" data-placement="top" title="Secure"></span>
                    }
                </h1>

                @{
                    foreach (string item in Model.DistinctFileExtensions())
                    {
                        <div class="extension detailExt bg_gray htCenter ext_@item">@item</div>
                    }
                }

                <div style="margin-top:-29px;">
                    <div class="btn-group rightFloat dataset-operation-button">
                        <button type="button"
                                class="btn btn-default borderdk_gray borderdk_@color dropdown"
                                data-toggle="dropdown" data-placement="top" title="Additional Actions">
                            <span class="glyphicon glyphicon-menu-hamburger @color"></span>
                        </button>

                        <ul class="dropdown-menu" x-placement="bottom-start" style="position: absolute; transform: translate3d(0px, 50px, 0px); top: -10px; left: 0px; will-change: transform;">
                            <li id="SubscribeModal" style="cursor: pointer;" data-id="@Model.DatasetId" data-placement="top" title="Subscribe">
                                <a>
                                    Subscribe
                                </a>
                            </li>

                            @if (Model.CanQueryTool)
                            {
                                <li title="Query Dataset">
                                    <a href="/Dataset/QueryTool?DatasetID=@Model.DatasetId">
                                        Query this Dataset
                                    </a>
                                </li>
                            }
                            @if (Model.CanEditDataset)
                            {
                                <li>
                                    <a href="/Config/Dataset/@Model.DatasetId">
                                        Manage Schemas
                                    </a>
                                </li>
                            }
                        </ul>
                    </div>

                    @if (Model.CanUpload)
                    {
                        <button type="button"
                                class="btn btn-default dataset-operation-button rightFloat borderdk_gray borderdk_@color"
                                id="UploadModal" data-id="@Model.DatasetId" data-toggle="tooltip" data-placement="top" title="Upload File">
                            <span class="glyphicon glyphicon-cloud-upload @color"></span>
                        </button>
                    }

                    @if (Model.CanEditDataset)
                    {
                        <button type="button"
                                class="btn btn-default btn dataset-operation-button rightFloat borderdk_gray borderdk_@color"
                                id="EditDataset_@Model.DatasetId" data-id="@Model.DatasetId" data-toggle="tooltip" data-placement="top" title="Edit Dataset">
                            <span class="glyphicon glyphicon-edit @color"></span>
                        </button>
                    }

                </div>
            </div>
        </div>
    </div>

    <br />

    <div class="hidden-md hidden-lg">
        <h1 class="detailName leftFloat @color">
            @Model.DatasetName

            @if (Model.IsSecured)
            {
                <span class="glyphicon glyphicon-lock lockIcon" data-toggle="tooltip" data-placement="top" title="Secure"></span>
            }
        </h1>

        <div>
            <div class="btn-group rightFloat dataset-operation-button" data-toggle="tooltip" data-placement="top" title="Additional Actions" style="margin-top: 5px;">
                <button type="button"
                        class="btn btn-default borderdk_gray borderdk_@color dropdown"
                        data-toggle="dropdown">
                    <span class="glyphicon glyphicon-menu-hamburger @color"></span>
                </button>

                <ul class="dropdown-menu" x-placement="bottom-start" style="position: absolute; transform: translate3d(0px, 50px, 0px); top: -10px; left: 0px; will-change: transform;">
                    <li id="SubscribeModal" style="cursor: pointer;" data-id="@Model.DatasetId" data-placement="top" title="Subscribe">
                        <a>
                            Subscribe
                        </a>
                    </li>

                    @if (Model.CanQueryTool)
                    {
                        <li title="Query Dataset">
                            <a href="/Dataset/QueryTool?DatasetID=@Model.DatasetId">
                                Query this Dataset
                            </a>
                        </li>
                    }
                    @if (Model.CanEditDataset)
                    {
                        <li>
                            <a href="/Config/Dataset/@Model.DatasetId">
                                Manage Schemas
                            </a>
                        </li>
                    }

                    @if (Model.CanUpload)
                    {
                        <li id="UploadModal" data-id="@Model.DatasetId">
                            <a>Upload Files</a>
                        </li>
                    }

                    @if (Model.CanEditDataset)
                    {
                        <li id="EditDataset_@Model.DatasetId" data-id="@Model.DatasetId">
                            <a>Edit Dataset</a>
                        </li>
                    }
                </ul>
            </div>
        </div>

    </div>

</div>


<br />

@using (Html.BeginForm("Fields", "Config", FormMethod.Post))
{
    @Html.AntiForgeryToken()

    <div data-bind="visible: Errors().length >= 1" style="display: none;">
        <h6 style="color: red;">Errors:</h6>
        <ul data-bind="template: {name: 'ErrorTemplate' , foreach: Errors()}"></ul>
    </div>

    <h2 class="@color">Fields for @schema.Name</h2>

    @Html.ValidationSummary(false, "", new { @class = "text-danger" })

    <div data-bind="visible: IsPositional" style="display:none;">
        <p>This is a positional aware file type.&nbsp&nbspDrag and drop fields to change field order.</p>
    </div>

    <div data-bind="visible: AllowArrays" style="display:none;">
        <p>This file type allows arrays.&nbsp&nbspCheck the "Is Array" option to signify an array.</p>
    </div>

    <div data-bind="visible: HiveDatabaseName() !== null" style="display:none;">
        <h6 class="@color">This schema is currently tied to the Hive Table named <span data-bind="text: HiveDatabaseName"></span>.<span data-bind="text: HiveTableName"></span> with <span data-bind="text: RowCount"></span> rows.  <b>You cannot edit it.</b></h6>
    </div>

    <div id="panelSpinner">
        <div class="sentry-spinner-container" style=" width: 1166px;">
            <span class="sentry-spinner" style="height:100px"></span>
        </div>
    </div>


    <div id="schemaPanel">
        <ul class="rules-group-container row fields-sortable-ul" id="fields" data-bind="template: {name: 'RowTemplate' , foreach: SortedRows}, css: SortableRows()" style="list-style-type: none;margin-left:0px;padding-left: 15px;"></ul>
    </div>


    <div style="margin-top: 10px;" class="col-lg-12">
        <hr />
        <button type="button" class="btn btn-sm btn-success" data-bind='click: addRow' style="margin-bottom: 8px;"><i class="glyphicon glyphicon-plus"></i> Add a Field</button>
        <hr />
        <button class="btn btn-success" id="saveBtn" data-bind='click: save'>Save</button>
        <div id="buttonSpinner" style="
                    display: inline-block;
                    margin-bottom: 24px;
                    margin-left: -20px;
                    display: none;
                ">
            <div class="sentry-spinner-container" style="width: 100px;display: inline-block;">
                <span class="sentry-spinner" style="height: 10px;width: 10px;"></span>
            </div>
        </div>
    </div>

    <script type="text/html" id="ErrorTemplate">
        <li>
            <span>Row # <span data-bind="text: Id"></span></span> :
            <span data-bind="text: Description"></span>
        </li>
    </script>

    <script type="text/html" id="RowTemplate">
        <li class="ui-sortable-handle schemaRowContainer" data-bind="css: $root.ClickableRows()">
            <div class="col-lg-12 schemaRow" data-bind="css: Color, style : { 'background-color' : RowColor }">
                <div class="rowDetails">
                    <div class="rowNumberIdentifier">
                        <b><span data-bind="text: Position"></span></b>
                    </div>
                    <button type="button" class="btn btn-xs btnExpandChildren" style="display: inline-block;  margin-bottom: 6px;" data-bind="click: ToggleChildren, visible: HasChildren, css : ButtonClass">
                        <span id="icon_" class="glyphicon" data-bind="css : ButtonSpanClass"></span>
                    </button>
                    <h6 style="float: left; margin-right: 6px; line-height: 0.5; width: 15px; display:none;" data-bind="text: Position"></h6>
                    <div class="col-lg-2">
                        <input class="col-lg-12 rowFieldName" data-bind="value: Name" placeholder="Field Name..." data-toggle="tooltip" data-placement="top" title="Field Name" />
                    </div>
                    <div class="col-lg-2">
                        <select class="typeSelect col-lg-12" data-bind="options: $root.DataTypes, optionsCaption: 'Choose Datatype', optionsValue: 'Name', optionsText: 'Name', optionsAfterRender: $root.setTagGroup, value: DataType"></select>
                        <input type="hidden" name="dataObjectField_Id" data-bind="value: DataObjectField_ID" data-toggle="tooltip" data-placement="top" title="Data Type Selection" />
                    </div>
                    <div class="showPandS col-lg-4" data-bind="visible: ShowPandS">
                        <div class="precisionContainer col-lg-2">
                            <input class="precision col-lg-12" data-bind="textInput: Precision" placeholder="Prec" data-toggle="tooltip" data-placement="top" title="Precision - default = @Sentry.data.Core.GlobalConstants.Datatypes.Defaults.DECIMAL_PRECISION_DEFAULT.ToString()" />
                        </div>
                        <div class="scaleContainer col-lg-2">
                            <input class="scale col-lg-12" data-bind="textInput: Scale" placeholder="Scale" data-toggle="tooltip" data-placement="top" title="Scale - default = @Sentry.data.Core.GlobalConstants.Datatypes.Defaults.DECIMAL_SCALE_DEFAULT.ToString()" />
                        </div>
                        <div class="col-lg-8">
                            <span>1234.56 = Precision:6  Scale:2</span>
                        </div>
                    </div>

                    <div class="showDateFormat col-lg-4" data-bind="visible: ShowDateFormat">
                        <input class="dateFormat col-lg-12" data-bind="value: Format" placeholder="Not Specified (default is @dateDefault)" data-toggle="tooltip" data-placement="top" title="Format - default = @Sentry.data.Core.GlobalConstants.Datatypes.Defaults.DATE_DEFAULT" />
                    </div>

                    <div class="showTimestampFormat col-lg-4" data-bind="visible: ShowTimestampFormat">
                        <input class="dateFormat col-lg-12" data-bind="value: Format" placeholder="Not Specified (default is @timestampDefault)" data-toggle="tooltip" data-placement="top" title="Format - default = @Sentry.data.Core.GlobalConstants.Datatypes.Defaults.TIMESTAMP_DEFAULT" />
                    </div>

                    <div class="showArray col-lg-2" data-bind="visible: $root.AllowArrays">
                        <label class="arrayLabel">IsArray?</label>
                        <input class="array col-lg-2" data-bind="checked: IsArray" type="checkbox" />
                    </div>

                    <div class="showLength col-lg-2" data-bind="visible: ShowFieldLength">
                        <input class="fieldlength col-lg-12" data-bind="visible: ShowFieldLength && DataType() === 'VARCHAR', value: Length" placeholder="default = @Sentry.data.Core.GlobalConstants.Datatypes.Defaults.VARCHAR_LENGTH_DEFAULT.ToString()" data-toggle="tooltip" data-placement="top" title="Length - default = @Sentry.data.Core.GlobalConstants.Datatypes.Defaults.VARCHAR_LENGTH_DEFAULT.ToString()" />
                        <input class="fieldlength col-lg-12" data-bind="visible: ShowFieldLength && DataType() !== 'VARCHAR', value: Length" placeholder="Specify length" data-toggle="tooltip" data-placement="top" title="Length - default = @Sentry.data.Core.GlobalConstants.Datatypes.Defaults.VARCHAR_LENGTH_DEFAULT.ToString()" />
                    </div>

                    <div class="options col-lg-4">
                        <div class="col-lg-12" data-bind="if: ShowAddChild">
                            <div class="col-lg-offset-2 col-lg-7" data-bind="visible: ShowAddChild">
                                <button class="rightButton" data-bind='click: addChild'>Add a Child</button>
                            </div>
                        </div>
                    </div>

                    <div class="descriptionContainer col-lg-12">
                        <input class="col-lg-10" data-bind="value: Description" placeholder="Description..." data-toggle="tooltip" data-placement="top" title="Description" />
                        <div class="rightButton col-lg-1 col-lg-offset-1" data-bind="visible: $parent.Name === undefined">

                            <button type="button" class="btn btn-xs btn-danger" data-bind='click: $parent.removeRow'>
                                <i class="glyphicon glyphicon-remove"></i>
                                Delete
                            </button>
                        </div>
                        <div class="rightButton col-lg-1 col-lg-offset-1" data-bind="visible: $parent.Name !== undefined">
                            <button type="button" class="btn btn-xs btn-danger" data-bind='click: $parent.removeChild'>
                                <i class="glyphicon glyphicon-remove"></i>
                                Delete
                            </button>
                        </div>
                    </div>


                </div>
                <span class="fieldGuidText" data-bind="text: FieldGuid"></span>
            </div>
            <ul class="childrenContainer" data-bind="template: {name: 'RowTemplate' , foreach: ChildRows}, visible: ShowChildren" style="list-style-type: none;margin-left:0px;padding-left: 10px;"></ul>
        </li>
    </script>
}

<style>
</style>


@section Scripts {

    <script>
        data.Fields.Init();

        var currentMax = 0;
        var errorList = [];

        ko.extenders.numeric = function (target, options) {
                //create a writable computed observable to intercept writes to our observable
            var precision = options.precision,
                min = options.min,
                max = options.max;

            var result = ko.pureComputed({
                read: target,  //always return the original observables value
                write: function (newValue) {
                    var current = target(),
                        roundingMultiplier = Math.pow(10, precision),
                        newValueAsNum = isNaN(newValue) ? 0 : parseFloat(+newValue),
                        valueToWrite = Math.round(newValueAsNum * roundingMultiplier) / roundingMultiplier;

                    if ((min != undefined || min != null) && valueToWrite < min) {
                        valueToWrite = min;
                    }

                    if ((max != undefined || max != null) && valueToWrite > max) {
                        valueToWrite = max;
                    }

                    //only write if it changed
                    if (valueToWrite !== current) {
                        target(valueToWrite);
                    } else {
                        //if the rounded value is the same, but a different value was written, force a notification for the current field
                        if (newValue !== current) {
                            target.notifySubscribers(valueToWrite);
                        }
                    }
                }
            }).extend({ notify: 'always' });

            //initialize with current value to make sure it is rounded appropriately
            result(target());

            //return the new computed observable
            return result;
            };

        function Row(id, indata, parent, level, parentRow) {
            var self = this;
            var parentvm = parent;
            var thisLevel = ++level;
            var parentRecord = parentRow;

            if (indata.Position != undefined && indata.Position !== 0) {
                self.Position = ko.observable(indata.Position);
                self.Toggled = ko.observable(false);
            }
            else {
                self.Position = ko.observable(id);
                self.Toggled = ko.observable(true);
            }
            self.DataObjectField_ID = ko.observable(indata.DataObjectField_ID);
            self.Name = ko.observable(indata.Name).extend({ notify: 'always' });
            self.FieldGuid = ko.observable(indata.FieldGuid);
            self.Description = ko.observable(indata.Description);
            self.DataType = ko.observable(indata.DataType).extend({ notify: 'always'});
            self.ArrayType = ko.observable(indata.ArrayType);
            //self.Precision = ko.observable(indata.Precision).extend({ numeric: { precision: 9, min: 1, max: 38 }});
            self.Precision = ko.observable(indata.Precision);
            //self.Scale = ko.observable(indata.Scale).extend({ numeric: { precision: 2, min: 1, max: 38 } });
            self.Scale = ko.observable(indata.Scale);
            self.Format = ko.observable(indata.Format);
            self.DeleteInd = ko.observable(false);
            self.IsArray = ko.observable(indata.IsArray);
            self.Level = ko.observable(thisLevel);
            //self.Length = ko.observable(indata.Length).extend({ numeric: { precision: 0, min: 1, max: 65535 } });
            self.Length = ko.observable(indata.Length);
            self.ChildRows = ko.observableArray(ko.utils.arrayMap(indata.ChildRows, function (rowInfo) {
                currentMax++;
                return new Row(currentMax, rowInfo, parentvm, thisLevel, self);
            }));
            self.RowColor = ko.observable()

            //Call UpdateRow() when any property changes
            self.Name.subscribe(        function () { self.UpdateRow() });
            self.FieldGuid.subscribe(   function () { self.UpdateRow() });
            self.Description.subscribe( function () { self.UpdateRow() });
            self.DataType.subscribe(    function () { self.UpdateRow() });
            self.ArrayType.subscribe(   function () { self.UpdateRow() });
            self.Precision.subscribe(   function () { self.UpdateRow() });
            self.Scale.subscribe(       function () { self.UpdateRow() });
            self.Format.subscribe(      function () { self.UpdateRow() });
            self.IsArray.subscribe(     function () { self.UpdateRow() });
            self.Length.subscribe(      function () { self.UpdateRow() });

            self.UpdateRow = function () {
                //alert("Row #" + self.Position() + " has updated its Name field.")

                if (parentRecord != undefined) {
                    parentRecord.UpdateRow();
                }

                var a = JSON.stringify(ko.toJS(self), ['Name', 'DataObjectField_ID', 'Description', 'DataType', 'ArrayType', 'Precision', 'Scale', 'ChildRows', 'Position', 'Format', 'DeleteInd', 'IsArray', 'FieldGuid', 'Length']);

                var url_parts = window.location.href.replace(/\/\s*$/, '').split('/');
                //since we do not need example.com
                url_parts.shift();

                //ajax
                $.ajax({
                    type: "POST",
                    url: "/Config/Schema/" + url_parts[5] + "/ValidateField",
                    data: a,
                    dataType: "json",
                    contentType: "application/json",
                    success: function (returnedData) {
                        if (Sentry.WasAjaxSuccessful(returnedData)) {                            
                           //No errors for field so remove any existing errors displayed
                            parentvm.Errors.remove(function (item) {
                                return item.Id === self.Position().toString();
                            });

                            //Remove error color from row
                            self.RowColor('');

                            //If there are no errors on page, show save button
                            if (parentvm.Errors !== undefined && parentvm.Errors().length === 0) {
                                $('#saveBtn').show();
                            }
                        }
                        else {
                            var previousId = 0;
                            for (var i = 0; i < returnedData.Errors.length; i++) {
                                if (previousId !== returnedData.Errors[i].Id) {
                                        //Remove all associated errors with this Id
                                        parentvm.Errors.remove(function (item) {
                                            return item.Id === returnedData.Errors[i].Id;
                                        });
                                    previousId = returnedData.Errors[i].Id;
                                }
                                parentvm.Errors.push({ 'Id': returnedData.Errors[i].Id, 'ErrorType': 'Type', 'Description': returnedData.Errors[i].Description });
                            }

                            //Adjust color of row
                            self.RowColor('rgba(255, 0, 0, 0.8)');

                            //Hide save button
                            $('#saveBtn').hide();
                        }
                    },
                    error: function (error) {
                        console.log(error);
                        //$('#buttonSpinner').hide();
                    },
                    async: false
                });
            }

            self.ShowFixed = ko.computed(function () {
                return parent.IsFixedWidth();
            });

            self.ShowPandS = ko.computed(function () {
                if (self.DataType() === 'DECIMAL') {
                    return true;
                }
                else {
                    return false;
                }
            });

            self.ShowDateFormat = ko.computed(function () {
                if (self.DataType() === 'DATE') {
                    return true;
                }
                else {
                    return false;
                }
            });

            self.ShowTimestampFormat = ko.computed(function () {
                if (self.DataType() === 'TIMESTAMP') {
                    return true;
                }
                else {
                    return false;
                }
            });

            self.ShowArrayType = ko.computed(function () {
                if (self.DataType() === 'ARRAY') {
                    return true;
                }
                else {
                    return false;
                }
            });

            self.ShowFieldLength = ko.computed(function () {
                if (self.ShowFixed() || self.DataType() === 'VARCHAR') {
                    return true;
                }
                else {
                    return false;
                }
            })

            self.ShowVarcharLengthDescription = ko.computed(function () {
                if (self.DataType() === 'VARCHAR') {
                    return true;
                }
                else {
                    return false;
                }
            })

            self.ShowAddChild = ko.computed(function () {
                if ((self.DataType() === 'STRUCT' || (self.DataType() === 'ARRAY' && self.ArrayType() === 'STRUCT')) && self.Toggled) {
                    return true;
                }
                else {
                    return false;
                }
            });

            self.ShowPositional = ko.computed(function () {
                return parent.IsPositional;
            })

            self.ShowChildren = ko.computed(function () {
                if (self.Toggled()) {
                    return true;
                } else {
                    return false;
                }
            });

            self.ShowSelf = ko.computed(function () {
                if (self.Toggled()) {
                    return true;
                } else {
                    return false;
                }
            });

            self.ToggleChildren = function () {
                if (self.Toggled()) {
                    self.Toggled(false);
                } else {
                    self.Toggled(true);
                }
            }

            self.ButtonClass = ko.computed(function () {
                return 'btn-success';
                //if (vm.ShowAllLayers()) {
                //    return 'disabled';
                //} else {
                //    return 'btn-success';
                //}
            });

            self.ButtonSpanClass = ko.computed(function () {
                if (self.Toggled()) {
                    return 'glyphicon-minus';
                } else {
                    return 'glyphicon-plus';
                }
            });

            self.HasChildren = ko.computed(function () {
                if (indata.DataType === 'STRUCT' || (indata.ChildRows !== undefined && indata.ChildRows !== null && indata.ChildRows.length > 0)) {
                    return true;
                } else {
                    return false;
                }
            });

            self.Color = ko.computed(function () {
                if (self.Level() % 2 == 0) {
                    return 'schemaColorEven';
                }
                else {
                    return 'schemaColorOdd';
                }
            })

            self.addChild = function () {
                //currentMax++;
                //self.ChildRows.push(new Row(currentMax, [{ DataObjectField_ID: "", Name: "", Description: "", DataType: "", ArrayType: "", Precision: null, Scale: null }], parent));

                currentMax++;
                var cr = new Row(currentMax, { DataObjectField_ID: "new" + currentMax, Name: "", Description: "", DataType: "", ArrayType: "", Precision: null, Scale: null }, parent, thisLevel, self);
                self.ChildRows.push(cr);
                if (!self.Toggled()) {
                    self.ToggleChildren();
                }

                self.UpdateRow();
            };

            self.removeChild = function (row) {
                parentvm.Errors.remove(function (item) { return item.Id === row.Position().toString(); });
                self.ChildRows.remove(row);
                //If there are no errors on page, show save button
                if (parentvm.Errors !== undefined && parentvm.Errors().length === 0) {
                    $('#saveBtn').show();
                }
            };

            self.removeChildren = function () {
                self.ChildRows().forEach(function (cRow) {
                    if (cRow.HasChildren) {
                        cRow.removeChildren();
                    }

                    parentvm.Errors.remove(function (item) {
                        return item.Id === cRow.Position();
                    });

                    cRow.DeleteInd(true);

                    //If there are no errors on page, show save button
                    if (parentvm.Errors !== undefined && parentvm.Errors().length === 0) {
                        $('#saveBtn').show();
                    }
                });
            }

            self.UpdateRow();
        };

        function ValidDataType(item) {
            this.Name = ko.observable(item.Name);
            this.Description = ko.observable(item.Description);
            this.Tag = ko.observable(item.Tag);
            return this;
        }

        var viewModel = function (incomingJson) {
            var self = this;

            
            //Observables
            //self.ErrorsCopy = ko.observableArray();
            self.Errors = ko.observableArray().extend({ notify: 'always' });
            self.DataTypes = ko.observableArray();
            self.IsPositional = ko.observable();
            self.IsFixedWidth = ko.observable();
            self.FilteredRows = ko.observableArray();
            self.SortedRows = ko.observableArray();
            self.HiveDatabaseName = ko.observable(incomingJson.HiveDatabaseName);
            self.HiveTableName = ko.observable(incomingJson.HiveTableName);
            self.FileExtensionId = incomingJson.FileExtension;
            self.AllowArrays = ko.observable();

            self.Rows = ko.observableArray(ko.utils.arrayMap(incomingJson.rows, function (rowInfo) {
                currentMax++;
                return new Row(currentMax, rowInfo, self, 0);
            }));
            self.RowCount = ko.observable(incomingJson.RowCount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
            self.FileExtensionName = ko.observable(incomingJson.FileExtensionName);

            self.Errors.subscribe(function () { self.ShowHideSaveButton() });
            self.ShowHideSaveButton = function () {
                //If there are no errors on page, show save button
                if (self.Errors !== undefined && self.Errors().length === 0) {
                    $('#saveBtn').show();
                }
                else if (self.Errors === undefined && self.Errors().length > 0) {
                    $('#saveBtn').hide();
                }
            };

            //Computed properties
            self.RowSorter = ko.computed(function () {
                self.SortedRows([]);
                self.SortedRows(ko.utils.arrayFilter(self.Rows(), function (row) {
                    return (row.DeleteInd() === false)
                }).sort(function (left, right) {
                    return left.Position() === right.Position() ? 0 : (left.Position() < right.Position() ? -1 : 1);
                }));
            });
            self.SortableRows = ko.computed(function () {
                return self.IsPositional() ? "sortable-fields-active" : "sortable-fields";
            })
            self.ClickableRows = ko.computed(function () {
                return self.IsPositional() ? "clickable" : "";
            })


            //Functions
            self.addRow = function () {
                currentMax++;
                var r = new Row(currentMax, { DataObjectField_ID: "new" + currentMax, Name: "", Description: "", DataType: "", ArrayType: "", Precision: null, Scale: null }, self, 0);
                self.Rows.push(r);
            };

            self.removeRow = function (row) {
                var position = row.Position();

                if (row.HasChildren) {
                    row.removeChildren();
                }
                

                self.Errors.remove(function (item) {
                    return item.Id === position;
                })

                row.DeleteInd(true);
                self.Rows.valueHasMutated();
                self.SortRows();
            };

            self.save = function () {
                console.log(ko.toJS(vm.Rows));
                var a = JSON.stringify(ko.toJS(vm.Rows), ['Name', 'DataObjectField_ID', 'Description', 'DataType', 'ArrayType', 'Precision', 'Scale', 'ChildRows', 'Position', 'Format', 'DeleteInd', 'IsArray', 'FieldGuid', 'Length']);
                console.log(a);

                var url_parts = window.location.href.replace(/\/\s*$/, '').split('/');
                //since we do not need example.com
                url_parts.shift();

                $('#buttonSpinner').show();

                $.ajax({
                    type: "POST",
                    url: "/Config/" + url_parts[3] + "/Schema/" + url_parts[5] + "/UpdateFields",
                    data: a,
                    dataType: "json",
                    contentType: "application/json",
                    success: function (returnedData) {
                        if (Sentry.WasAjaxSuccessful(returnedData)) {                            
                            $('#buttonSpinner').hide();
                            window.location.href = "/Config/Dataset/@Model.DatasetId";
                        }
                        else {
                            $('#buttonSpinner').hide();
                            var modal = Sentry.ShowModalAlert(returnedData.Message, function () { })
                        }
                    },
                    error: function (error) {
                        console.log(error);
                        $('#buttonSpinner').hide();
                    },
                    async: false
                });

            };

            self.setTagGroup = function (option, item) {
                //console.log(item);
                if (item !== undefined && item.Tag()) {
                    var grp = $(option).parent("select").find("[label=\"" + item.Tag() + "\"]");
                    if (grp.length == 0) {
                        grp = $("<optGroup></optGroup>");
                        grp.attr("label", item.Tag());
                        $(option).parent("select").append(grp);
                    }
                    grp.append($(option));
                }
            };

            self.SortRows = function () {
                newVal = 0;
                $('.schemaRowContainer').each(function (index) {
                    var httpItem = $(this).children().children().children().children('input[name="dataObjectField_Id"]').val();
                    var match = ko.utils.arrayFirst(self.SortedRows(), function (item) {
                        if (item.DataObjectField_ID() == httpItem && item.Position() != index + 1) {
                            item.Position(index + 1);
                        }
                    })
                })
            }            

            $.ajax({
                type: "GET",
                url: "/Config/GetDatatypesByFileExtension/" + self.FileExtensionId,
                contentType: "application/json",
                success: function (returnedData) {
                    self.IsPositional(returnedData.IsPositional);
                    self.IsFixedWidth(returnedData.IsFixedWidth);
                    self.AllowArrays(returnedData.AllowArrays);
                    self.DataTypes($.map(returnedData.ValidDatatypes, function (item) {
                        return new ValidDataType(item);
                    }));
                },
                async: false
            });
            
        };

        var initialData = [
            {
                Name: "Parent1", Description: "LaRusso", DataType: "ARRAY", ArrayType: "STRUCT", Precision: "", Scale: "",
                ChildRows: [
                    {
                        Name: "Child1", Description: "LaRusso", DataType: "STRUCT", ArrayType: "", Precision: "", Scale: "",
                        ChildRows: [
                            {
                                Name: "Child11", Description: "LaRusso", DataType: "INTEGER", ArrayType: "", Precision: "", Scale: "",
                            },
                            {
                                Name: "Child12", Description: "LaRusso", DataType: "STRUCT", ArrayType: "", Precision: "", Scale: "",
                                ChildRows: [
                                    { Name: "Child121", Description: "LaRusso", DataType: "INTEGER", ArrayType: "", Precision: "", Scale: "" },
                                    { Name: "Child122", Description: "LaRusso", DataType: "INTEGER", ArrayType: "", Precision: "", Scale: "" }
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                Name: "Parent2", Description: "LaRusso", DataType: "INTEGER", ArrayType: "", Precision: "", Scale: ""
            }
        ];

        var vm;
        $(function () {

            var url_parts = window.location.href.replace(/\/\s*$/, '').split('/');
            //since we do not need example.com
            url_parts.shift();

            $.ajax({
                type: "GET",
                url: "/api/v1/metadata/datasets/" + url_parts[3] + "/schemas/" + url_parts[5] + "/columns" ,
                contentType: "application/json",
                success: function (returnedData) {
                    console.log(returnedData);
                    $('#panelSpinner').hide();
                    $('#rowsContainer').show();

                    vm = new viewModel(returnedData);
                    ko.applyBindings(vm);

                    if (returnedData.RowCount >= 1 && returnedData.HiveDatabaseName != null && returnedData.HiveTableName != null) {
                        $("button").prop("disabled", true);
                        $("select").prop("disabled", true);
                        $("input").prop("disabled", true);
                    }
                },
                async: false
            });

            $(document).ready(function () {
                $(".sortable-fields-active").sortable({
                    stop: function (event, ui) {
                        vm.SortRows();
                    }
                });
            });

        });

    </script>

}
